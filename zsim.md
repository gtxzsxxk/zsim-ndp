# zsimåˆ†æ

## å¯åŠ¨æµç¨‹

### zsim harness

ç¼–è¯‘zsimé¡¹ç›®ä¼šäº§ç”Ÿä¸¤ä¸ªäºŒè¿›åˆ¶ï¼Œä¸€ä¸ªæ˜¯libzsim.soï¼Œä¸€ä¸ªæ˜¯zsimã€‚zsimçš„æœ¬ä½“æ˜¯zsim_harness.cppï¼Œè€Œä¸PINæœ‰å…³çš„zsim.cppä¼šè¢«ç¼–åˆ°libzsim.soå†…ã€‚

zsim_harnessçš„mainå‡½æ•°å†…ï¼Œæ ¹æ®ç¬¬ä¸€ä¸ªå‚æ•°å¾—åˆ°configFileçš„è·¯å¾„ï¼Œç„¶åè®¾ç½®æ¯ä¸ªsignalçš„å¤„ç†ï¼Œå‡ ä¹åªè¦æ˜¯signalå°±ç›´æ¥é‡å¼€ï¼ŒæŠŠæ•´ä¸ªè¿›ç¨‹æ ‘éƒ½å¹²æ‰ã€‚

ç„¶åæ ¹æ®sim.gmMBytesç”³è¯·å†…å­˜ï¼Œç„¶åä½¿ç”¨**PinCmd**ç±»æ¥åŠ è½½libzsim.soï¼Œç”Ÿæˆç›®æ ‡ç¨‹åºæ­£ç¡®çš„argsï¼Œå¾—åˆ°æ€»å…±çš„è¿›ç¨‹æ•°ï¼ˆä¹Ÿå°±æ˜¯éœ€è¦ä»¿çœŸå¤šå°‘ä¸ªç¨‹åºï¼Œåœ¨zsim.cfgä¸­ç”¨process0ã€process1è¿›è¡Œé…ç½®ï¼‰ï¼Œç„¶ååˆ›å»ºè¿›ç¨‹ã€‚

è¿›å…¥åˆ›å»ºè¿›ç¨‹çš„å‡½æ•°ï¼ˆLaunchProcessï¼‰åï¼Œä¼šè°ƒç”¨forkåˆ›å»ºæ–°çš„è¿›ç¨‹ï¼Œparentè¿›ç¨‹ä¼šç›´æ¥æ‘¸é±¼è¿”å›ï¼Œè€Œchildè¿›ç¨‹å°±è¦è°ƒç”¨execvpè¿›å…¥ç›®æ ‡ç¨‹åºï¼Œé¡ºä¾¿è¿›å…¥zsim.cppçš„mainå‡½æ•°ã€‚

è¿™ä¸ªæ—¶å€™parentè¿›ç¨‹å°±ä¼šå¼€å§‹æ‘¸é±¼ï¼Œç­‰å¾…å­è¿›ç¨‹ç»“æŸã€‚ä½œä¸ºå¤–éƒ¨è§‚å¯Ÿè€…ï¼Œç›‘æ§æ¨¡æ‹Ÿæ˜¯å¦â€œå¡ä½â€ã€‚wait() æ‰€æœ‰é€€å‡ºçš„å­è¿›ç¨‹ï¼Œé˜²æ­¢å®ƒä»¬å˜â€œåƒµå°¸â€ã€‚å®šæœŸæ‰“å°å¿ƒè·³ï¼Œå¹¶åœ¨æ¨¡æ‹Ÿå™¨å´©æºƒæ—¶æä¾›ä¸€äº›çº¿ç´¢ã€‚

### zinfo

**GlobSimInfo**æ˜¯ä¸€ä¸ªåŸºäºå…±äº«å†…å­˜çš„è¿›ç¨‹é—´çŠ¶æ€ç®¡ç†ç±»ã€‚

### libzsim.so

è¿›å…¥åˆ°libzsim.soåï¼Œå°†æ‰§è¡Œzsim.cppçš„mainå‡½æ•°ã€‚

é¦–å…ˆæ‰§è¡Œäº†PIN_InitSymbolså’ŒPIN_Initï¼Œåˆå§‹åŒ–PINã€‚ç„¶åè°ƒç”¨PIN_AddInternalExceptionHandlerè®¾ç½®InternalExceptionHandlerå‡½æ•°ä¸ºå¼‚å¸¸handlerï¼Œæœ¬è´¨ä¸Šå°±æ˜¯backtraceç„¶åç»“æŸè¿›ç¨‹ã€‚

ç„¶åä¼šè·å–ç›®å‰å±äºç¬¬å‡ ä¸ªè¿›ç¨‹ï¼Œå¦‚æœæ˜¯ç¬¬0ä¸ªè¿›ç¨‹ï¼Œå°±å¼€å§‹æ‰§è¡ŒSimInitå‡½æ•°ã€‚

#### SimInit

SimInitå‡½æ•°ä¼šåˆå§‹åŒ–zinfoï¼Œé…ç½®å¥½ä»¿çœŸçš„æ ¸å¿ƒæ•°ï¼Œè®¾ç½®å¥½sim.domainsã€sim.contentionThreadsç­‰é€‰é¡¹ï¼Œåˆå§‹åŒ–**ContentionSim**ç±»ï¼Œ

ç„¶åé…ç½®sim.phaseLengthã€sim.statsPhaseIntervalã€sys.frequencyç­‰ã€‚

ç„¶ååˆå§‹åŒ–ä¸€ä¸ª**EventQueue**ç±»ï¼Œå¦‚æœæ²¡æœ‰è¢«é…ç½®æˆtraceDrivenæ¨¡å¼ï¼Œé‚£ä¹ˆå°±åˆå§‹åŒ–**Scheduler**ç±»ã€‚

è°ƒç”¨InitGlobalStatsåˆå§‹åŒ–å…¨å±€çŠ¶æ€ã€‚

åˆå§‹åŒ–**AggregateStat**ç±»ï¼Œåˆå§‹åŒ–**PortVirtualizer**ç±»ã€‚

ç„¶åè°ƒç”¨CreateProcessTreeåˆ›å»ºè¿›ç¨‹æ ‘ã€‚è°ƒç”¨InitNUMAè®¾ç½®å’ŒéªŒè¯NUMAæ¨¡æ‹Ÿç¯å¢ƒï¼Œç„¶ååˆ›å»º**NUMAMap**ç±»ã€‚

è°ƒç”¨InitSystemåˆå§‹åŒ–cacheã€coreå’Œmemory controllerã€‚ä¼šæŠŠè¿™äº›çš„hierarchyç»„åˆæˆä¸€ä¸ªmapå’Œparentã€childçš„å…³ç³»ï¼ŒInitSystem å‡½æ•° new å‡ºäº†ä¸€ç³»åˆ—æ ¸å¿ƒç±»ï¼Œä¸»è¦åŒ…æ‹¬ï¼šSimpleCoreã€TimingCore æˆ– OOOCoreï¼ˆCPU æ ¸å¿ƒï¼‰ï¼ŒBaseCache çš„å„ç§å­ç±»ï¼ˆç¼“å­˜ï¼‰ï¼ŒMemInterconnectã€MemRouter å’Œ MemInterconnectInterfaceï¼ˆæ€»çº¿/äº’è¿ï¼‰ï¼Œä»¥åŠ BuildMemoryController è¿”å›çš„ MemObjectï¼ˆå†…å­˜æ¡ï¼‰ã€‚è¿™äº› new å¥½çš„å¯¹è±¡å¹¶æ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„â€œå…¨å±€åˆ—è¡¨â€ï¼›ç›¸åï¼Œå®ƒä»¬é€šè¿‡ setParents() å’Œ setChildren() æ–¹æ³•è¢«â€œç„Šæ¥â€åœ¨äº†ä¸€èµ·ã€‚æœ€ç»ˆï¼Œæ‰€æœ‰çš„ CPU æ ¸å¿ƒ æŒ‡é’ˆè¢«å­˜æ”¾åœ¨å…¨å±€çš„ zinfo->cores æ•°ç»„ä¸­ï¼Œè€Œç¼“å­˜ã€æ€»çº¿å’Œå†…å­˜åˆ™é€šè¿‡å½¼æ­¤çš„çˆ¶/å­æŒ‡é’ˆï¼Œæ„æˆäº†ä¸€ä¸ªä»æ ¸å¿ƒï¼ˆCoreï¼‰ç›´è¾¾å†…å­˜ï¼ˆMemoryï¼‰çš„å®Œæ•´ã€å¯éå†çš„å±‚çº§æ ‘ã€‚

å¦‚æœå®šä¹‰äº†ï¼Œå°±æ‰§è¡Œzinfo->sched->initStatsã€‚new **ProcessStats**ç±»ï¼Œnew **ProcStats**ç±»ï¼Œnew **VectorCounter**ç±»ä½œä¸ºzinfo->profHeartbeatsçš„å€¼ï¼Œå¤„ç†ä¸€äº›æ‚é¡¹åæ‰§è¡Œzinfo->contentionSim->postInitï¼Œå¹¶è®¾ç½®gm_set_glob_ptr(zinfo)ï¼Œå³å®ŒæˆSimInitã€‚

SimInitè°ƒç”¨ç»“æŸåï¼Œåˆå§‹åŒ–fPtrså’Œcidsã€‚fPtrsæ˜¯æ‰€æœ‰ä»¿çœŸthreadçš„å‡½æ•°æŒ‡é’ˆé›†åˆã€‚æ¯ä¸€ä¸ªthreadå¯¹åº”äº†è‡ªå·±çš„loadPtrã€storePtrã€bblPtrã€branchPtrã€predLoadPtrã€predStorePtrï¼Œè¿™äº›æ˜¯zsimä¸­å¯¹ä¸åŒä»¿çœŸæ•°æ®çš„å¤„ç†å‡½æ•°ã€‚cidsæ˜¯ç‰©ç†ä¸Šçš„æ ‡è¯†ç¬¦ï¼Œæ ‡è¯†ä»£è¡¨zsimæ¨¡æ‹Ÿçš„ç¡¬ä»¶CPUæ ¸å¿ƒï¼ˆcoreï¼‰ã€‚tid(Thread ID): é€»è¾‘æ ‡è¯†ç¬¦ã€‚ä»£è¡¨æ­£åœ¨æ¨¡æ‹Ÿçš„åº”ç”¨ç¨‹åºä¸­çš„çº¿ç¨‹ã€‚zsimä¸­è¿˜æœ‰ä¸€ä¸ªgidï¼Œå°±æ˜¯ä¸€ä¸ª32ä½çš„æ•´æ•°ï¼Œå®ƒçš„é«˜16ä½æ˜¯pidï¼Œä½16ä½æ˜¯tidã€‚

ç„¶åå¼€å§‹è°ƒç”¨VirtCaptureClocksè®¾ç½®è™šæ‹ŸåŒ–çš„**ClockDomainInfo**ç±»ã€‚

#### FFIInit

ç„¶åè°ƒç”¨FFIInitå‡½æ•°åœ¨è¿›ç¨‹startæ—¶åˆå§‹åŒ–Fast-Forward Intervalsã€‚è¿™ä¸ªå‡½æ•°è¯»å–ffiPointsåˆ—è¡¨ï¼ˆä¾‹å¦‚ [1M, 9M]ï¼‰ã€‚è®¾ç½®ç¬¬ä¸€ä¸ªæŒ‡ä»¤é™åˆ¶ ffiInstrsLimit = 1000000ã€‚æ­¤æ—¶ï¼Œæ¨¡æ‹Ÿå™¨å¤„äºNFF (è¯¦ç»†æ¨¡æ‹Ÿ) æ¨¡å¼ã€‚

è°ƒç”¨FFITrackNFFInterval()ã€‚è¿™ä¸ªå‡½æ•°â€œè®¾ç½®ä¸€ä¸ªé—¹é’Ÿâ€ã€‚å®ƒä½¿ç”¨makeAdaptiveEventåˆ›å»ºä¸€ä¸ªäº‹ä»¶ï¼Œæ’å…¥åˆ°zinfo->eventQueueä¸­ã€‚è¿™ä¸ªäº‹ä»¶å°†åœ¨ ffiInstrsLimitè¿™ä¹ˆå¤šï¼ˆå³100ä¸‡æ¡ï¼‰è¯¦ç»†æŒ‡ä»¤è¢«æ‰§è¡Œåè§¦å‘ã€‚è§¦å‘çš„æ˜¯ffiFire lambda(åˆ‡æ¢åˆ° FF)ï¼šå½“è¿™100ä¸‡æ¡è¯¦ç»†æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼Œ"é—¹é’Ÿ"å“èµ·ï¼ŒffiFireè¿™ä¸ªlambdaåŒ¿åå‡½æ•°è¢«æ‰§è¡Œã€‚å®ƒæ‰“å° "Entering fast-forward" å¹¶è°ƒç”¨ zinfo->procArray[p]->enterFastForward()ã€‚æ¨¡æ‹Ÿå™¨åˆ‡æ¢åˆ°FF(å¿«è¿›)æ¨¡å¼ã€‚FFIEntryBasicBlockä½œä¸ºè¿‡æ¸¡å‡½æ•°è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå®ƒä¼šè°ƒç”¨FFIAdvance()ã€‚

ç„¶åæ‰§è¡ŒVirtInitå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯patchç³»ç»Ÿè°ƒç”¨ï¼Œpatchäº†ä»¥ä¸‹éƒ¨åˆ†ï¼š

#### VirtInit

åˆå§‹åŒ–zsimçš„ç³»ç»Ÿè°ƒç”¨è™šæ‹ŸåŒ–åŠŸèƒ½ã€‚

1. ğŸ“ æ–‡ä»¶ç³»ç»Ÿ (fs.cpp) Syscalls: SYS_open, SYS_openatã€‚ç”¨é€”ï¼š æ‹¦æˆªæ–‡ä»¶æ‰“å¼€è¯·æ±‚ã€‚è¿™æ˜¯ä¸ºäº†æä¾›ä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆpatchRootï¼‰ã€‚å½“ç¨‹åºå°è¯•è¯»å– /sys/devices/system/nodeï¼ˆNUMA æ‹“æ‰‘ï¼‰æˆ– /proc/cpuinfoï¼ˆCPU ä¿¡æ¯ï¼‰æ—¶ï¼Œzsim ä¼šæ‹¦æˆªè¿™ä¸ªè¯·æ±‚ï¼Œå¹¶ç»™å®ƒè¿”å›ä¸€ä¸ªä¼ªé€ çš„ã€æè¿°æ¨¡æ‹Ÿç³»ç»Ÿæ‹“æ‰‘çš„æ–‡ä»¶ã€‚

2. ğŸŒ ç«¯å£/ç½‘ç»œ (ports.cpp) Syscalls: SYS_bind, SYS_getsockname, SYS_connectã€‚ç”¨é€”ï¼š è™šæ‹ŸåŒ–ç½‘ç»œç«¯å£ã€‚è¿™å…è®¸å¤šä¸ª zsim æ¨¡æ‹Ÿçš„è¿›ç¨‹åœ¨æ¨¡æ‹Ÿçš„ç½‘ç»œä¸Šäº’ç›¸é€šä¿¡ï¼Œè€Œä¸ä¼šå ç”¨æˆ–å¹²æ‰°å®¿ä¸»æœºçš„çœŸå®ç½‘ç»œç«¯å£ã€‚

3. ğŸ–¥ï¸ CPU è™šæ‹ŸåŒ– (cpu.cpp) Syscalls: SYS_getcpu, SYS_sched_getaffinity, SYS_sched_setaffinityã€‚ç”¨é€”ï¼š å‘ç¨‹åºâ€œè°æŠ¥â€CPU ä¿¡æ¯ã€‚å½“ç¨‹åºè¯¢é—®â€œæˆ‘åœ¨å“ªä¸ªCPUä¸Šè¿è¡Œï¼Ÿâ€ï¼ˆgetcpuï¼‰æˆ–â€œæˆ‘å…è®¸åœ¨å“ªäº›CPUä¸Šè¿è¡Œï¼Ÿâ€ï¼ˆgetaffinityï¼‰æ—¶ï¼Œzsim ä¼šæ‹¦æˆªå®ƒï¼Œå¹¶æ ¹æ® Scheduler çš„è°ƒåº¦ï¼ˆgid -> cid çš„æ˜ å°„ï¼‰è¿”å›æ¨¡æ‹Ÿçš„ CPU æ ¸å¿ƒ IDï¼ˆcidï¼‰ï¼Œè€Œä¸æ˜¯å®¿ä¸»æœºçš„ CPU IDã€‚

4. ğŸ§  NUMA è™šæ‹ŸåŒ– (numa.cpp) Syscalls: SYS_get_mempolicy, SYS_set_mempolicy, SYS_mbind, SYS_munmap, SYS_mremap ç­‰ã€‚ç”¨é€”ï¼š è¿™æ˜¯ NUMAMap æœºåˆ¶çš„æ ¸å¿ƒã€‚zsim å¿…é¡»æ‹¦æˆªæ‰€æœ‰ç®¡ç†å†…å­˜ç­–ç•¥çš„è°ƒç”¨ã€‚set_mempolicy: å½“ç¨‹åºè®¾ç½®å†…å­˜ç­–ç•¥ï¼ˆå¦‚â€œæœ¬åœ°ä¼˜å…ˆâ€æˆ–â€œäº¤é”™â€ï¼‰æ—¶ï¼Œzsim æ‹¦æˆªå®ƒï¼Œå¹¶å°†è¿™ä¸ªç­–ç•¥ä¿å­˜åˆ° NUMAMap çš„ threadPolicy ä¸­ã€‚munmap: å½“ç¨‹åºé‡Šæ”¾å†…å­˜æ—¶ï¼Œzsim æ‹¦æˆªå®ƒï¼Œä»¥ä¾¿æ›´æ–° NUMAMap ä¸­çš„ PageMapï¼ˆé¡µ -> èŠ‚ç‚¹ï¼‰æ˜ å°„ã€‚

5. ğŸ›‘ çº¿ç¨‹æ§åˆ¶ (control.cpp) Syscalls: SYS_exit_groupã€‚ç”¨é€”ï¼š ä¼˜é›…åœ°ç»ˆæ­¢æ¨¡æ‹Ÿã€‚å½“è¢«æ¨¡æ‹Ÿçš„ç¨‹åºï¼ˆçš„ä¸»çº¿ç¨‹ï¼‰é€€å‡ºæ—¶ï¼Œzsim å¿…é¡»æ•è·è¿™ä¸ªäº‹ä»¶ï¼Œä»¥ä¾¿åœæ­¢æ‰€æœ‰æ¨¡æ‹Ÿç»„ä»¶ã€åˆ·æ–°æ‰€æœ‰ç»Ÿè®¡æ•°æ®å¹¶å¹²å‡€åœ°é€€å‡ºï¼Œè€Œä¸æ˜¯è®©æ•´ä¸ª Pin å·¥å…·å´©æºƒã€‚

6. â° æ—¶é—´ä¸è¶…æ—¶ (time.cpp, timeout.cpp) Syscalls: SYS_gettimeofday, SYS_time, SYS_nanosleep, SYS_futex, SYS_poll ç­‰ã€‚ç”¨é€”ï¼š æ—¶é—´è™šæ‹ŸåŒ–ã€‚è¿™æ˜¯æ¨¡æ‹Ÿå™¨æœ€å…³é”®çš„è¡¥ä¸ä¹‹ä¸€ã€‚è·å–æ—¶é—´ï¼š å½“ç¨‹åºè¯¢é—®â€œç°åœ¨å‡ ç‚¹äº†ï¼Ÿâ€ï¼ˆgettimeofdayï¼‰ï¼Œzsim ä¼šè¿”å›æ¨¡æ‹Ÿæ—¶é—´ï¼ˆå³ zinfo->globPhaseCyclesï¼‰ï¼Œè€Œä¸æ˜¯çœŸå®çš„æŒ‚é’Ÿæ—¶é—´ã€‚é˜»å¡/ç¡çœ ï¼š å½“ç¨‹åºè°ƒç”¨ nanosleep æˆ– futexï¼ˆç­‰å¾…é”ï¼‰æ—¶ï¼Œå®ƒæœ¬æ„æ˜¯â€œé˜»å¡â€è‡ªå·±ã€‚å¦‚æœ zsim è®©å®¿ä¸»æœº OS çœŸçš„é˜»å¡å®ƒï¼Œæ•´ä¸ªæ¨¡æ‹Ÿéƒ½ä¼šå¡ä½ã€‚zsim ä¼šæ‹¦æˆªè¿™ä¸ªè°ƒç”¨ï¼Œåœ¨ Scheduler ä¸­å°†è¯¥çº¿ç¨‹è®¾ä¸º SLEEPING æˆ– BLOCKED çŠ¶æ€ï¼Œç„¶åç»§ç»­æ¨è¿›æ¨¡æ‹Ÿæ—¶é—´ï¼Œç›´åˆ°æ»¡è¶³å”¤é†’æ¡ä»¶ã€‚

#### VdsoInit

åœ¨è°ƒç”¨å®ŒVirtInitå‡½æ•°åï¼Œå°±ä¼šå¼€å§‹è°ƒç”¨VdsoInitå‡½æ•°ã€‚VirtInit è´Ÿè´£æ‹¦æˆªæ™®é€šçš„ç³»ç»Ÿè°ƒç”¨ï¼ˆé‚£äº›ä¼šé™·å…¥å†…æ ¸çš„ï¼‰ï¼Œè€Œ VdsoInit è´Ÿè´£æ‹¦æˆªèµ°æ·å¾„çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆé‚£äº›å®Œå…¨åœ¨ç”¨æˆ·æ€å®Œæˆçš„ï¼‰ã€‚ä¸»è¦é’ˆå¯¹clock_gettimeã€gettimeofdayã€timeã€getcpuã€‚

#### æ’æ¡©

åœ¨åˆå§‹åŒ–å®Œè™šæ‹ŸåŒ–åï¼Œå°±è¦è¿›è¡Œæ’æ¡©äº†ï¼Œæ’æ¡©çš„éƒ¨åˆ†å¦‚ä¸‹ï¼š

1. æ ¸å¿ƒæŒ‡ä»¤æµæ’æ¡©ã€‚ä½¿ç”¨TRACE_AddInstrumentFunctionå‡½æ•°ï¼Œæ¯å½“ Pin å‘ç°ä¸€ä¸ªæ–°çš„ Traceï¼Œå®ƒå°±ä¼šè°ƒç”¨ zsim çš„ Trace() å‡½æ•°ã€‚
2. çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ä½¿ç”¨PIN_AddThreadStartFunctionå‡½æ•°å’ŒPIN_AddThreadFiniFunctionå‡½æ•°ã€‚å½“ç›®æ ‡ç¨‹åº pthread_create æ—¶ï¼Œzsim éœ€è¦åœ¨è‡ªå·±çš„ Scheduler ä¸­æ³¨å†Œè¿™ä¸ªæ–°çº¿ç¨‹ï¼Œåˆ†é…ä¸€ä¸ª ThreadInfoï¼Œå¹¶ç»™å®ƒåˆ†é…ä¸€ä¸ªæ¨¡æ‹Ÿæ ¸å¿ƒ (cid)ã€‚Fini: å½“çº¿ç¨‹é€€å‡ºæ—¶ï¼Œzsim éœ€è¦å›æ”¶èµ„æºï¼Œå¹¶åœ¨ Scheduler ä¸­æ³¨é”€å®ƒã€‚å®ç°çš„å‡½æ•°æ˜¯ThreadStartå’ŒThreadFiniã€‚
3. ç³»ç»Ÿè°ƒç”¨æ‹¦æˆªã€‚ä½¿ç”¨PIN_AddSyscallEntryFunctionå‡½æ•°å’ŒPIN_AddSyscallExitFunctionå‡½æ•°ã€‚è°ƒç”¨çš„å‡½æ•°ä¸ºSyscallEnterå’ŒSyscallExitã€‚ä½¿ç”¨PIN_AddContextChangeFunctionå‡½æ•°å½“å‘ç”Ÿéæ­£å¸¸çš„æ§åˆ¶æµæ”¹å˜ï¼ˆä¸»è¦æ˜¯ä¿¡å· Signal å¤„ç†ï¼‰æ—¶è°ƒç”¨ContextChangeå‡½æ•°ã€‚
4. è¿›ç¨‹ä¸å¤šä»»åŠ¡ã€‚ä½¿ç”¨PIN_AddFiniFunctionå‡½æ•°åœ¨ç›®æ ‡ç¨‹åºå½»åº•ç»“æŸï¼ˆexitï¼‰æ—¶è°ƒç”¨Finiå‡½æ•°ã€‚Finiå‡½æ•°åˆä¼šæ¥ç€è°ƒç”¨SimEndå‡½æ•°æ‰§è¡ŒçœŸæ­£çš„ç»“æŸä»»åŠ¡ã€‚åŒæ—¶éœ€è¦å¤„ç†è¿›ç¨‹æ ‘çš„æ¨¡æ‹Ÿã€‚ä½¿ç”¨PIN_AddFollowChildProcessFunctionæŒ‡å®šFollowChildï¼ˆå‘Šè¯‰ Pinï¼Œå¦‚æœå½“å‰ç¨‹åºè°ƒç”¨äº† exec å¯åŠ¨æ–°ç¨‹åºï¼Œè¯·ç»§ç»­è·Ÿè¸ªæ–°ç¨‹åºï¼ŒæŠŠPinToolæ³¨å…¥è¿›å»ï¼‰ã€‚ç„¶åPIN_AddForkFunctionè®¾ç½®è°ƒç”¨BeforeForkï¼ˆèµ‹å€¼é™æ€å˜é‡forkedChildNodeä¸ºprocTreeNode->getNextChild()ï¼‰ï¼ŒAfterForkInParentï¼ˆforkedChildNodeè®¾ç½®ä¸ºnullptrï¼‰å’ŒAfterForkInChildï¼ˆè°ƒç”¨procTreeNode->notifyStart()ï¼Œè¾“å‡ºæ–°è¿›ç¨‹çš„ä¿¡æ¯ï¼Œå¹¶ä¸”åˆå§‹è¿™ä¸ªæ–°PINè¿›ç¨‹çš„fPtrsä¸ºjoinPtrsã€cidsä¸ºUNINITIALIZED_CIDï¼Œå¹¶ä¸”è®©å­è¿›ç¨‹ä¹Ÿå¼€å§‹æ‰§è¡ŒFFThreadï¼‰ã€‚ç„¶åä¸»è¿›ç¨‹çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹å¹¶æ‰§è¡ŒFFThreadå‡½æ•°ï¼Œç„¶åè‡ªå·±é€šè¿‡PIN_StartProgramå‡½æ•°ä¸å†è¿”å›ã€‚æ‰€ä»¥è¿™é‡Œå…¶å®æ¨¡æ‹Ÿå™¨ç¨‹åºæœ¬èº«æœ€ç»ˆè¿è¡Œçš„éƒ½æ˜¯FFThreadå‡½æ•°ï¼Œä¸ç®¡æ˜¯ä¸»è¿›ç¨‹è¿˜æ˜¯forkåçš„è¿›ç¨‹ï¼Œéƒ½éœ€è¦FFThreadå‡½æ•°è¿›è¡Œä»¿çœŸã€‚

### Trace

åŒºåˆ†ä¸¤ä¸ªæ—¶é—´ç‚¹ï¼š

1. æ’æ¡©æ—¶ (Instrumentation Time)ï¼šå³ Trace() å‡½æ•°æ‰§è¡Œçš„æ—¶å€™ã€‚è¿™æ˜¯ Pin åœ¨å³æ—¶ç¼–è¯‘ï¼ˆJITï¼‰ä»£ç ï¼Œå®ƒå†³å®šäº†â€œè¦æ’å…¥ä»€ä¹ˆä»£ç â€ã€‚

2. åˆ†æ/æ‰§è¡Œæ—¶ (Analysis/Execution Time)ï¼šå³ç›®æ ‡ç¨‹åºçœŸæ­£è¿è¡Œçš„æ—¶å€™ã€‚æ­¤æ—¶ï¼Œè¢«æ’å…¥çš„é‚£äº›å‡½æ•°ï¼ˆå¦‚ IndirectBasicBlockï¼‰æ‰ä¼šè¢«çœŸæ­£è°ƒç”¨ã€‚

#### 1. æ€»å…¥å£

å½“ Pin å‘ç°ä¸€æ®µæ–°çš„ä»£ç è½¨è¿¹ï¼ˆTraceï¼Œé€šå¸¸æ˜¯ä¸€ä¸²åŸºæœ¬å— Basic Blockï¼‰æ—¶è°ƒç”¨ã€‚å®ƒçš„ä»»åŠ¡æ˜¯éå†è¿™æ®µä»£ç ï¼Œæ’å…¥ zsim çš„å›è°ƒå‡½æ•°ã€‚

ä»£ç é¦–å…ˆéå† Trace ä¸­çš„æ¯ä¸€ä¸ªåŸºæœ¬å—ï¼ˆBBLï¼‰ã€‚å‰ææ¡ä»¶ï¼š å¦‚æœå½“å‰å¤„äºâ€œå¿«è¿›æ¨¡å¼â€(FastForward) ä¸”ä¸éœ€è¦é‡æ’æ¡©ï¼Œåˆ™è·³è¿‡æ­¤æ­¥ï¼ˆä¸ºäº†æ€§èƒ½ï¼‰ã€‚

- Decoder::decodeBbl(bbl, ...)ï¼š
    - å¹²ä»€ä¹ˆï¼šè¿™æ˜¯ä¸€ä¸ªé™æ€åˆ†æè¿‡ç¨‹ã€‚å®ƒåˆ†æè¿™ä¸ª BBL é‡Œæœ‰å¤šå°‘æŒ‡ä»¤ã€æœ‰å¤šå°‘å†…å­˜æ“ä½œã€æŒ‡ä»¤é—´çš„ä¾èµ–å…³ç³»ç­‰ã€‚
    - äº§å‡ºï¼šç”Ÿæˆä¸€ä¸ª BblInfo ç»“æ„ä½“ï¼Œé‡Œé¢åŒ…å«äº†æ¨¡æ‹Ÿè¿™ä¸ª BBL æ‰€éœ€çš„æ‰€æœ‰å…ƒæ•°æ®ï¼ˆæŒ‡ä»¤æ•°ã€å­—èŠ‚æ•°ç­‰ï¼‰ã€‚
- BBL_InsertCall(..., IndirectBasicBlock, ...)ï¼š
    - å¹²ä»€ä¹ˆï¼šåœ¨ BBL çš„å¼€å¤´æ’å…¥ä¸€ä¸ªè°ƒç”¨ã€‚
    - æ’å…¥äº†è°ï¼šIndirectBasicBlockã€‚
    - å‚æ•°ï¼šä¼ å…¥äº† BblInfo æŒ‡é’ˆã€‚
    - æ„ä¹‰ï¼šå½“ç¨‹åºè¿è¡Œåˆ°è¿™ä¸ªåŸºæœ¬å—æ—¶ï¼Œzsim ä¼šå…ˆè·å¾—æ§åˆ¶æƒï¼Œæ‹¿åˆ°è¿™ä¸ªå—çš„å…ƒæ•°æ®ï¼Œç„¶åç®—å‡ºè¿™ä¸ªå—æ¶ˆè€—äº†å¤šå°‘å‘¨æœŸï¼ˆCycleï¼‰ï¼Œæ¨è¿›æ¨¡æ‹Ÿæ—¶é—´ã€‚

#### 2. æŒ‡ä»¤ (Instruction) çº§æ’æ¡©

æ¥ç€ï¼Œä»£ç å†æ¬¡éå† BBLï¼Œå¹¶æ·±å…¥éå†å…¶ä¸­çš„æ¯ä¸€æ¡æŒ‡ä»¤ï¼ˆINSï¼‰ã€‚è°ƒç”¨ï¼šInstruction(ins)ã€‚èŒè´£ï¼šå†³å®šå¯¹å½“å‰è¿™æ¡å…·ä½“çš„æŒ‡ä»¤â€œåšç‚¹ä»€ä¹ˆâ€ã€‚

- å†…å­˜è®¿é—®æ’æ¡© (Memory Access)
    - åˆ¤æ–­ï¼šé€šè¿‡ INS_IsMemoryRead / INS_IsMemoryWrite æ£€æŸ¥æŒ‡ä»¤æ˜¯å¦è¯»å†™å†…å­˜ã€‚
    - æ’å…¥ï¼š
        - å¦‚æœæ˜¯è¯»ï¼šæ’å…¥ IndirectLoadSingleã€‚
        - å¦‚æœæ˜¯å†™ï¼šæ’å…¥ IndirectStoreSingleã€‚
    - å‚æ•°ï¼šä¼ å…¥ IARG_MEMORYREAD_EA (æœ‰æ•ˆåœ°å€)ã€‚
    - æ„ä¹‰ï¼šè¿™æ˜¯ Cache æ¨¡æ‹Ÿçš„åŸºç¡€ã€‚zsim éœ€è¦æ‹¦æˆªæ¯ä¸€æ¬¡å†…å­˜è®¿é—®çš„åœ°å€ï¼Œæ‰”ç»™ Cache å±‚æ¬¡ç»“æ„å»åˆ¤æ–­æ˜¯ Hit è¿˜æ˜¯ Missã€‚
- åˆ†æ”¯é¢„æµ‹æ’æ¡© (Branch Prediction)
    - åˆ¤æ–­ï¼šINS_Category(ins) == XED_CATEGORY_COND_BRï¼ˆæ¡ä»¶è·³è½¬ï¼‰ã€‚
    - æ’å…¥ï¼šIndirectRecordBranchã€‚
    - æ„ä¹‰ï¼šå°†åˆ†æ”¯çš„è·³è½¬æ–¹å‘ï¼ˆTaken/Not Takenï¼‰å’Œç›®æ ‡åœ°å€ä¼ ç»™ CPU æ¨¡å‹çš„åˆ†æ”¯é¢„æµ‹å™¨ (Branch Predictor)ï¼Œç”¨æ¥æ›´æ–°é¢„æµ‹å†å²å¹¶è®¡ç®—é¢„æµ‹å¤±è´¥çš„æƒ©ç½šã€‚

##### è™šæ‹ŸåŒ–ä¸é­”æ³•æŒ‡ä»¤ (Virtualization & Magic)

è¿™æ˜¯ zsim èƒ½å¤Ÿâ€œæ¬ºéª—â€ç›®æ ‡ç¨‹åºçš„å…³é”®ã€‚

- Magic Ops (xchg %rcx, %rcx)ï¼š
    - æ’å…¥ï¼šHandleMagicOpã€‚
    - åŠŸèƒ½ï¼šè¿™æ˜¯ä¸€ä¸ªâ€œåé—¨â€ã€‚è¢«æ¨¡æ‹Ÿçš„ç¨‹åºå¯ä»¥é€šè¿‡è¿™æ¡ç‰¹æ®Šçš„æ±‡ç¼–æŒ‡ä»¤å‘Šè¯‰ zsimï¼šâ€œå¼€å§‹æ„Ÿå…´è¶£åŒºåŸŸ(ROI)â€ã€â€œå¿ƒè·³â€ã€â€œæ³¨å†Œçº¿ç¨‹â€ç­‰ã€‚è¿™å®ç°äº† Guest å’Œ Host çš„é€šä¿¡ã€‚
- CPUID (FakeCPUIDPre/Post)ï¼š
    - æ’å…¥ï¼šåœ¨ CPUID æŒ‡ä»¤çš„å‰åæ’å…¥ã€‚
    - åŠŸèƒ½ï¼šCPUID æŒ‡ä»¤é€šå¸¸è¿”å›å®¿ä¸»æœºçš„ CPU ä¿¡æ¯ã€‚zsim å¿…é¡»æ‹¦æˆªå®ƒï¼Œç¯¡æ”¹å¯„å­˜å™¨ï¼ˆEAX, EBX ç­‰ï¼‰çš„å€¼ï¼Œè®©ç¨‹åºä»¥ä¸ºè‡ªå·±è¿è¡Œåœ¨ zsim é…ç½®çš„é‚£ä¸ª 64 æ ¸ CPU ä¸Šï¼Œè€Œä¸æ˜¯ä½ çš„ç¬”è®°æœ¬ç”µè„‘ä¸Šã€‚ä»£ç ä¸­å¯ä»¥çœ‹åˆ°å®ƒè®¡ç®— apicId å’Œ siblings çš„é€»è¾‘ã€‚
- RDTSC (FakeRDTSCPost)ï¼š
    - æ’å…¥ï¼šåœ¨ RDTSC æŒ‡ä»¤åæ’å…¥ã€‚
    - åŠŸèƒ½ï¼šRDTSC è¯»å–ç¡¬ä»¶çš„æ—¶é—´æˆ³è®¡æ•°å™¨ã€‚zsim å¿…é¡»æ‹¦æˆªå¹¶è¦†ç›–å®ƒçš„è¿”å›å€¼ï¼ˆEAX:EDXï¼‰ï¼Œå¡«å…¥ zinfo->globPhaseCyclesï¼ˆæ¨¡æ‹Ÿæ—¶é—´ï¼‰ã€‚å¦‚æœè¿™é‡Œä¸æ‹¦æˆªï¼Œç¨‹åºè¯»åˆ°çš„æ˜¯çœŸå®ä¸–ç•Œçš„é£å¿«æµé€çš„æ—¶é—´ï¼Œæ¨¡æ‹Ÿç»“æœå°±ä¼šå®Œå…¨é”™è¯¯ï¼ˆTime Leakageï¼‰ã€‚

#### 3. Indirect... ç³»åˆ—å‡½æ•°ä¸ fPtrsï¼šå¤šæ€çš„å®ç°

fPtrs (Function Pointers)ï¼šè¿™æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªçº¿ç¨‹ (tid) å¯¹åº”ä¸€ä¸ª InstrFuncPtrs ç»“æ„ä½“ï¼Œé‡Œé¢å­˜ç€ loadPtr, storePtr, bblPtr ç­‰å‡½æ•°æŒ‡é’ˆã€‚

- å½“çº¿ç¨‹å¤„äº Detailed Simulation (NFF) æ¨¡å¼æ—¶ï¼ŒfPtrs[tid] æŒ‡å‘çœŸæ­£çš„æ¨¡æ‹Ÿå‡½æ•°ï¼ˆå¦‚ SimLoadï¼‰ã€‚
- å½“çº¿ç¨‹å¤„äº Fast Forward (FF) æ¨¡å¼æ—¶ï¼ŒfPtrs[tid] æŒ‡å‘ç©ºå‡½æ•°ï¼ˆNopLoadï¼‰ã€‚
- å½“çº¿ç¨‹å¤„äº Null/Blocked çŠ¶æ€æ—¶ï¼Œå®ƒæŒ‡å‘å¦ä¸€ç»„å‡½æ•°ã€‚

### FFThread

### ThreadStart

### ThreadFini

### SyscallEnter

### SyscallExit

### ContextChange

### Fini

### SimEnd

### PinCmd

### ContentionSim

### EventQueue

### Scheduler

### AggregateStat

### PortVirtualizer

### NUMAMap

### ProcessStats

### ProcStats

### 